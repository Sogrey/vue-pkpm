<!DOCTYPE html>
    <html lang="en">
        <head>
        <meta charset="UTF-8"  name="viewport" content="width=device-width,initial-scale=1.0" />
        <title>Title</title>
        <link rel="stylesheet" href="https://api.cloud.pkpm.cn/bimviewer/viewer/v5/obv.css" type="text/css" />
        <link rel="resource" type="application/l10n" href="https://api.cloud.pkpm.cn/bimviewer/viewer/v5/locale/locale.properties">
        <script src="https://api.cloud.pkpm.cn/bimviewer/viewer/v5/obv.js"></script>
        <link rel="stylesheet" href="https://cloud.pkpm.cn/playground/lod/examples/css/uikit.min.css" />
        <script src="https://lib.baomitu.com/echarts/4.7.0/echarts-en.min.js"></script>
        <style>
            @media (max-width: 760px) {
              .my-obv-domContainer {
                top: 110px !important;
                right: 0 !important;
                /*display: block !important;*/
              }
              .my-obv-domContainer button {
                font-size: 12px;
                padding: 0 10px;
              }
            }
            html, body {
              width: 100%;
              height: 100%;
              margin: 0px;
              padding: 0px;
              background: #3c3f41;
            }
            .my-obv-viewer {
              position: relative;
              width: 100%;
              height: 100%;
              display: inline-block;
            }
            .my-obv-domContainer {
              position: absolute;
              z-index: 99;
              top: 160px;
              right: 8px;
              display: flex;
              flex-wrap: wrap-reverse;
              flex-direction: column;
            }
            .my-obv-domContainer button {
              border-radius: 30px;
              margin-top: 20px;
              margin-right: 20px;
              float: right;
            }
        </style>
        </head>
        <body>
            <script src="https://cesium.com/downloads/cesiumjs/releases/1.102/Build/Cesium/Cesium.js"></script>
<link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.102/Build/Cesium/Widgets/widgets.css"/>
<div id="cesiumContainer" style="width: 100%; height:100%"></div>

            <script type="module">
            let urn = "urn:bimbox.object:viewing_bucket/pmodel-lod";
let host = "https://api.cloud.pkpm.cn";
let urnType = "pmodel-lod";
let bimsId = "65e57e34993dc7fac12fce59";
var viewer = new Cesium.Viewer("cesiumContainer", {
    animation: false,  //是否显示动画控件
    baseLayerPicker: false, //是否显示图层选择控件
    geocoder: false, //是否显示地名查找控件
    timeline: true, //是否显示时间线控件
    sceneModePicker: false, //是否显示投影方式控件
    navigationHelpButton: false, //是否显示帮助信息控件
    infoBox: true,  //是否显示点击要素之后显示的信息
    homeButton: false,
    fullscreenButton: false,

    imageryProvider: new Cesium.UrlTemplateImageryProvider({
        url: "https://webst02.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}",
        maximumLevel: 18}),
});

viewer.scene.screenSpaceCameraController.zoomEventTypes = [Cesium.CameraEventType.WHEEL, Cesium.CameraEventType.PINCH];
viewer.scene.screenSpaceCameraController.tiltEventTypes = [Cesium.CameraEventType.PINCH, Cesium.CameraEventType.RIGHT_DRAG];

viewer.scene.light.intensity = 10;
viewer.clockViewModel.currentTime = new Cesium.JulianDate.fromIso8601('2023-08-02T08:00:00Z')//UTC
viewer.timeline.updateFromClock();

var options = {};
options.defaultResetView = Cesium.Rectangle.fromDegrees(71, 3, 90, 14);
// Only the compass will show on the map
options.enableCompass = true;
options.enableZoomControls = false;
options.enableDistanceLegend = false;

let headerToken;

main().then(function(data){
    const resource = new Cesium.Resource({
        url: data.url,
        headers: {
            "Authorization": data.token
        },
    });

    var pos1 = Cesium.Cartesian3.fromDegrees(116.5875740049029, 39.90861869311058, 10);
    // var pos1 = Cesium.Cartesian3.fromDegrees(115.9350667,39.61258886,10);
    var matrix1 = Cesium.Transforms.eastNorthUpToFixedFrame(pos1);

    var rz = Cesium.Matrix3.fromRotationZ(Cesium.Math.toRadians(284.275254));
    var rotationZ = Cesium.Matrix4.fromRotationTranslation(rz);
    // Cesium.Matrix4.multiply(matrix1, rotationZ, matrix1);

    let tileset2 = new Cesium.Cesium3DTileset({
        url: resource
    });
    tileset2.readyPromise.then(function(tileset2)
    {
        viewer.scene.primitives.add(tileset2);
        // tileset2.shadows = Cesium.ShadowMode.ENABLED;
        // tileset2.debugShowBoundingVolume = true;
        tileset2._root.transform = matrix1;
        viewer.zoomTo(tileset2, new Cesium.HeadingPitchRange(0, -tileset2.boundingSphere.radius * 10.0,
            0));
        // tileset2._root.transform = matrix;
    });
})

var handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
const selected = {
    feature: undefined,
    originalColor: new Cesium.Color(),
};

// An entity object which will hold info about the currently selected feature for infobox display
const selectedEntity = new Cesium.Entity();

// Get default left click handler for when a feature is not picked on left click
const clickHandler = viewer.screenSpaceEventHandler.getInputAction(
    Cesium.ScreenSpaceEventType.LEFT_CLICK
);

// If silhouettes are supported, silhouette features in blue on mouse over and silhouette green on mouse click.
// If silhouettes are not supported, change the feature color to yellow on mouse over and green on mouse click.
if (
    Cesium.PostProcessStageLibrary.isSilhouetteSupported(viewer.scene)
) {
    // Silhouettes are supported
    const silhouetteBlue = Cesium.PostProcessStageLibrary.createEdgeDetectionStage();
    silhouetteBlue.uniforms.color = Cesium.Color.BLUE;
    silhouetteBlue.uniforms.length = 0.01;
    silhouetteBlue.selected = [];

    const silhouetteGreen = Cesium.PostProcessStageLibrary.createEdgeDetectionStage();
    silhouetteGreen.uniforms.color = Cesium.Color.LIME;
    silhouetteGreen.uniforms.length = 0.01;
    silhouetteGreen.selected = [];

    viewer.scene.postProcessStages.add(
        Cesium.PostProcessStageLibrary.createSilhouetteStage([
            silhouetteBlue,
            silhouetteGreen,
        ])
    );

    // Silhouette a feature on selection and show metadata in the InfoBox.
    viewer.screenSpaceEventHandler.setInputAction(function onLeftClick(
            movement
        ) {
            // If a feature was previously selected, undo the highlight
            silhouetteGreen.selected = [];

            // Pick a new feature
            const pickedFeature = viewer.scene.pick(movement.position);

            if (!Cesium.defined(pickedFeature)) {
                clickHandler(movement);
                return;
            }

            // Highlight newly selected feature
            silhouetteGreen.selected = [pickedFeature];

            getPro(pickedFeature);
        },
        Cesium.ScreenSpaceEventType.LEFT_CLICK);
}

// 获取属性信息
function getPro(pickedFeature) {
    if(Cesium.defined(pickedFeature)) {
        return new Promise((resolve, reject) => {
            var url = host +"/bims-api/bims/v2/subdatas/" + bimsId+"/components/search";
            var batchId = pickedFeature._content.batchTable._propertyTable._jsonMetadataTable._properties.dbId[pickedFeature._batchId];
            let senddata = {
                "propsConditions":[
                    {
                        "key":"batch:id",
                        "operateSymbol":4,
                        "value": JSON.stringify(batchId)
                    }
                ]
            };
            // 获取token
            let token = '';
            getAccessToken((data) => {
                token = data;
            });
            const xhr = new XMLHttpRequest(); // no arguments
            xhr.open('POST', url, true);
            xhr.setRequestHeader('Authorization', 'Bearer ' + token);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify(senddata));
            xhr.onload = function() {
                // 请结合系统样式，自定义属性面板
                alert(xhr.response)
            };
        });
    }
}

async function main() {
    // 创建实例需要传入的参数，部署环境serviceConfig 和 用户有效期getAccessToken
    let applicationOptions = {
        // 配置 OBV 服务端（BIMServer）API 服务的 origin，这个适合于私有部署的用户使用
        getAccessToken: getAccessToken,
        refreshAccessToken: getAccessToken,
        serviceConfig: {
            origin: host,
            apiContextPath: '/bimserver/viewing/v3',
        },
    }

    // 实例化 Builder，用于模型加载
    const builder = new OBV.Api.ObvBuilder()
    // 创建 Application 对象
    const application = await builder.buildApplication(applicationOptions)
    // 创建 document 管理视图，加载完成后可以调用接口

    const obvDocument = await builder.loadDocument(application,
        urn, urnType) //jobType为流式转换任务的任务类型
    // 获取元数据文件
    let manifest = obvDocument._manifest;

    //获取resultkey
    var manifestUrn = manifest.urn;
    var pos = manifestUrn.lastIndexOf("/");
    var resultkey = manifestUrn.substr(pos);

    let rePath;
    for(let i = 0; i < manifest.children[0].children.length; i++) {
        if(manifest.children[0].children[i].type === 'geometry') {
            if(manifest.children[0].children[i].children[0].role === 'graphics') {
                // 获取数据相对路径
                var viewUrn = manifest.children[0].children[i].children[0].urn; //以元数据文件中描述的第一个三维视图为例
                pos = viewUrn.indexOf("/");
                rePath = viewUrn.substr(pos);
                break;
            }
        }
    }

    // 字段拼接生成模型url
    var urlHead = host +"/bimserver/viewing/v3/datas";
    var modelUrl = urlHead + resultkey + rePath;

    headerToken = applicationOptions.serviceConfig.headers.Authorization;

    return {
        token: headerToken,
        url: modelUrl
    }
}
main()
// 访问的令牌 getAccessToken 和 令牌有效期 expiresIn 
function getAccessToken(callBack) {
    callBack('eyJhbGciOiJSUzI1NiJ9.eyJzY29wZSI6WyJvYnY6cmVhZCJdLCJleHAiOjE3NjY2NDEwNjEsImNsaWVudF9pZCI6ImFlY3dvcmtzLW9idi1jb21tdW5pdHkiLCJqdGkiOiIzNzhmM2Q4MS0yMGI4LTRjZWQtYWFhMi01OThmNjg1MDJhMDAifQ.Hkdyz_ZNqjzjjhc9hfOmXdervJqCNlsCGgotjTgu--9oSyU1TivYY-RysMOmlLcO4O7L2iTxwSyPaM02HRMvafCfemfg4VNY9JUdgW0M_1HdCPlOy67wTFT7aDBeAaWTKQ0VCDonEvKZ8uB1hMq19SsxniCTwDnqOq_ICxq5EmMGRaXemu5pDBre0KnkDBAt17pU_m1gH-QI3BNnl4aEuuiXdDL5jjv5oJdFYdgQ5JfOtAjg5yaqvOyypqo2jgPXwgv3XEpgrHdV3kKUG1Jv3nXyGmZjtHylYlpXE8tg3BOdZjqGlOt91yRnElfLhGQMkrtZwGumMUNJ-u3y9C28Rw', 36000)
}

            </script>
        </body>
    </html>
