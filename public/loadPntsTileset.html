<!DOCTYPE html>
    <html lang="en">
        <head>
        <meta charset="UTF-8"  name="viewport" content="width=device-width,initial-scale=1.0" />
        <title>Title</title>
        <link rel="stylesheet" href="https://api.cloud.pkpm.cn/bimviewer/viewer/v5/obv.css" type="text/css" />
        <link rel="resource" type="application/l10n" href="https://api.cloud.pkpm.cn/bimviewer/viewer/v5/locale/locale.properties">
        <script src="https://api.cloud.pkpm.cn/bimviewer/viewer/v5/obv.js"></script>
        <link rel="stylesheet" href="https://cloud.pkpm.cn/playground/lod/examples/css/uikit.min.css" />
        <script src="https://lib.baomitu.com/echarts/4.7.0/echarts-en.min.js"></script>
        <style>
            @media (max-width: 760px) {
              .my-obv-domContainer {
                top: 110px !important;
                right: 0 !important;
                /*display: block !important;*/
              }
              .my-obv-domContainer button {
                font-size: 12px;
                padding: 0 10px;
              }
            }
            html, body {
              width: 100%;
              height: 100%;
              margin: 0px;
              padding: 0px;
              background: #3c3f41;
            }
            .my-obv-viewer {
              position: relative;
              width: 100%;
              height: 100%;
              display: inline-block;
            }
            .my-obv-domContainer {
              position: absolute;
              z-index: 99;
              top: 160px;
              right: 8px;
              display: flex;
              flex-wrap: wrap-reverse;
              flex-direction: column;
            }
            .my-obv-domContainer button {
              border-radius: 30px;
              margin-top: 20px;
              margin-right: 20px;
              float: right;
            }
        </style>
        </head>
        <body>
            <div id="viewer" class="my-obv-viewer"></div>
<div id="domContainer" class="my-obv-domContainer">
    <button id="pnts_removePntsTileset" class="uk-button uk-button-primary">卸载指定点云模型</button>
    <button id="pnts_createTileset" class="uk-button uk-button-primary">加载点云模型</button>
    <button id="pnts_removeAllPntsTileset" class="uk-button uk-button-primary">卸载全部点云模型</button>
    <button id="pnts_show/hide" class="uk-button uk-button-primary">隐藏/显示点云模型</button>
    <br>
    <label>
        设置高度值:
        <span id="pntsHeight" class="pntsHeight" style="color:blue;width: 60px;display: inline-block;"></span>
        <input id="pntsHeightRange" type="range" value="0.0" min="0" max="60" step="0.1"
               style="margin:10px 10px 10px 5px"/>
    </label>
    <label>
        设置透明度:
        <span id="pntsOpacity" class="pntsOpacity" style="color:blue;width: 60px;display: inline-block;"></span>
        <input id="pntsOpacityRange" type="range" value="1.0" min="0" max="1.0" step="0.1"
               style="margin:10px 10px 10px 5px"/>
    </label>
    <label>
        设置点大小:
        <span id="pntsPointSize" class="pntsPointSize" style="color:blue;width: 60px;display: inline-block;"></span>
        <input id="pntsPointSizeRange" type="range" value="1.0" min="0" max="5.0" step="0.1"
               style="margin:10px 10px 10px 5px"/>
    </label>
    <br>
    <button id="mergeBimModel" class="uk-button uk-button-primary">载入BIM模型</button>
    <button id="unloadBimModel" class="uk-button uk-button-primary">卸载BIM模型</button>
</div>
            <script type="module">
            let obvApi;

async function main() {
    const applicationOptions = {
        // 配置 OBV 服务端（BIMServer）API 服务的 origin，这个适合于私有部署的用户使用
        getAccessToken: getAccessToken,
        serviceConfig: {
            origin: 'https://api.cloud.pkpm.cn',
            apiContextPath: '/bimserver/viewing/v3',
        },
    };
    // 定义urn，模型的唯一标识
    let pointCloudUrn = 'urn:bimbox.object:viewing_bucket/las-model';
    let bimUrn = 'urn:bimbox.object:viewing_bucket/rvt-house';
    let urnList = [
        {
            urn: pointCloudUrn,
            jobType: 'las-lod'
        }, {
            urn: bimUrn,
            jobType: 'rvt-lod'
        }
    ]

    // 实例化 Builder，用于模型加载
    const builder = new OBV.Api.ObvBuilder();
    // 创建 Application 对象
    const application = await builder.buildApplication(applicationOptions);
    // 创建 viewer 容器, 创建API
    // 重要提示：如果在响应式框架如Vue/React/Angular中加载OBV，不要将obvApi变成响应式对象，会导致页面卡顿甚至崩溃！！！
    // 详细解释见：https://cloud.pkpm.cn/devcenter/commonQuestion/#2-1&7
    obvApi = await builder.buildViewer3d(application, document.getElementById('viewer'));
    // 分别创建每个模型的document 管理视图
    const urnMap = new Map();
    for (let i = 0; i < urnList.length; i++) {
        // 创建 document 管理视图，加载完成后可以调用接口
        const document = await builder.loadDocument(application, urnList[i].urn, urnList[i].jobType);
        urnMap.set(urnList[i].urn, document);
    }

    let haveBimModel = false;
    let havePntsModel = true;
    let visible = true;
    const options = {
        applicationId: application.id
    }

    // 加载指定的点云模型
    await obvApi.createPntsTileset(urnMap.get(pointCloudUrn), options);

    document.getElementById('pnts_createTileset').onclick = function () {
        obvApi.createPntsTileset(urnMap.get(pointCloudUrn), options);
        if (!havePntsModel) {
            havePntsModel = true;
            alert("多个点云模型加载完成后，可以统一调整所有点云模型的高度、显隐、透明度、点大小，也可以通过在接口中增加可选参数\'urn\'，对指定模型进行调整。")
        }

    };

    document.getElementById('pnts_removePntsTileset').onclick = function () {
        obvApi.removePntsTileset(pointCloudUrn);
        if (havePntsModel) {
            havePntsModel = false;
        }
    };

    document.getElementById('pnts_removeAllPntsTileset').onclick = function () {
        obvApi.removeAllPntsTileset();
        havePntsModel = false;
    };

    document.getElementById('pnts_show/hide').onclick = function () {
        if (!visible) {
            obvApi.setPntsVisible(true);
            visible = true;
        } else {
            obvApi.setPntsVisible(false);
            visible = false;
        }
    };

    document.getElementById('mergeBimModel').onclick = async function () {
        if (!haveBimModel) {
            //加载BIM模型,实现合模
            // let urn = 'urn:bimbox.file:EOFgv5KdSC/1EIc7OpOMhD?version=1';
            const bimDocument = urnMap.get(bimUrn);
            const viewer3dItems = bimDocument.get3dGeometryItems();
            builder.load3dModels(obvApi, {
                obvDocument: bimDocument,
                viewer3dItem: viewer3dItems[0],
                modelOffset: {x: 200, y: -50, z: 10},
            });
            haveBimModel = true;
        }
    };

    document.getElementById('unloadBimModel').onclick = async function () {
        if (haveBimModel) {
            const ids = obvApi.getModelIds();
            for (let i = 0; i < ids.length; i++) {
                let model = obvApi.getModelById(ids[i]);
                obvApi.unloadModel(ids[i]);
                model.dispose();
                model = null;
            }
            haveBimModel = false;
        }
    };
    update();
}

function update() {
    let height = 0;
    const pntsHeightRange = document.getElementById('pntsHeightRange');
    const pntsHeight = document.getElementById('pntsHeight');
    pntsHeight.innerText = '0.0';
    pntsHeightRange.oninput = () => {
        height = pntsHeightRange.value;
        const val = parseFloat(height);
        const formattedSize = val.toFixed(1);
        pntsHeight.innerText = formattedSize;
        obvApi.setPntsHeight(val);
    };

    let opacity = 1.0;
    const pntsOpacityRange = document.getElementById('pntsOpacityRange');
    const pntsOpacity = document.getElementById('pntsOpacity');
    pntsOpacity.innerText = '1.0';
    pntsOpacityRange.oninput = () => {
        opacity = pntsOpacityRange.value;
        const val = parseFloat(opacity);
        const formattedSize = val.toFixed(1);
        pntsOpacity.innerText = formattedSize;
        obvApi.setPntsOpacity(val);
    };

    let size = 1.0;
    const pntsPointSizeRange = document.getElementById('pntsPointSizeRange');
    const pntsPointSize = document.getElementById('pntsPointSize');
    pntsPointSize.innerText = '1.0';
    pntsPointSizeRange.oninput = () => {
        size = pntsPointSizeRange.value;
        const val = parseFloat(size);
        const formattedSize = val.toFixed(1);
        pntsPointSize.innerText = formattedSize;
        obvApi.setPntsPointSize(val);
    };

}

// 调用main函数进行代码的实现
main();
// 访问的令牌 getAccessToken 和 令牌有效期 expiresIn 
function getAccessToken(callBack) {
    callBack('eyJhbGciOiJSUzI1NiJ9.eyJzY29wZSI6WyJvYnY6cmVhZCJdLCJleHAiOjE3NjY2NDEwNjEsImNsaWVudF9pZCI6ImFlY3dvcmtzLW9idi1jb21tdW5pdHkiLCJqdGkiOiIzNzhmM2Q4MS0yMGI4LTRjZWQtYWFhMi01OThmNjg1MDJhMDAifQ.Hkdyz_ZNqjzjjhc9hfOmXdervJqCNlsCGgotjTgu--9oSyU1TivYY-RysMOmlLcO4O7L2iTxwSyPaM02HRMvafCfemfg4VNY9JUdgW0M_1HdCPlOy67wTFT7aDBeAaWTKQ0VCDonEvKZ8uB1hMq19SsxniCTwDnqOq_ICxq5EmMGRaXemu5pDBre0KnkDBAt17pU_m1gH-QI3BNnl4aEuuiXdDL5jjv5oJdFYdgQ5JfOtAjg5yaqvOyypqo2jgPXwgv3XEpgrHdV3kKUG1Jv3nXyGmZjtHylYlpXE8tg3BOdZjqGlOt91yRnElfLhGQMkrtZwGumMUNJ-u3y9C28Rw', 36000)
}

            </script>
        </body>
    </html>
